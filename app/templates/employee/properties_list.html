{% extends 'base.html' %}
{% block title %}{{ _('Properties') }}{% endblock %}

{% block content %}

<!-- Custom Styles -->
<style>
.card-section {
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    padding: 20px;
    margin-bottom: 20px;
    background-color: #ffffff;
}

.table tbody tr:hover {
    background-color: #f1f5f9;
}

.badge-status {
    text-transform: capitalize;
    font-weight: 500;
}

.btn-copy:active {
    transform: scale(0.95);
}
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-building me-1"></i>{{ _('Properties') }}</h3>
  <div class="btn-group">
    <a class="btn btn-primary" href="{{ url_for('employee.properties_create') }}">
      <i class="bi bi-plus-circle me-1"></i>{{ _('Add Property') }}
    </a>
    <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#addBuildingModal">
      <i class="bi bi-plus-square me-1"></i>{{ _('Add Building') }}
    </button>
  </div>
</div>

{% if only == 'unleased' %}
<div class="alert alert-info d-flex justify-content-between align-items-center">
  <div>{{ _('Filtered to unleased properties') }}</div>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('employee.properties_list') }}">{{ _('Clear filter') }}</a>
</div>
{% endif %}

<!-- Responsive Cards Grid -->
<div class="card-section">
  <h5 class="mb-3"><i class="bi bi-bank me-1"></i>{{ _('Buildings') }}</h5>
  <div class="row g-3">
    {% for p in buildings %}
    <div class="col-6 col-md-4 col-lg-3">
      <div class="card h-100">
        {% set img = (p.images.split(',')[0] if p.images else None) %}
        {% if img %}
          <img class="square-thumb" src="{{ url_for('uploaded_file', filename=img) }}" alt="{{ p.title }}" />
        {% else %}
          <div class="square-thumb d-flex align-items-center justify-content-center text-muted">{{ _('No image') }}</div>
        {% endif %}
        <div class="card-body p-2">
          <div class="fw-semibold text-truncate" title="{{ p.title }}">{{ p.title }}</div>
          <div class="d-flex align-items-center justify-content-between mt-1">
            <span class="badge badge-status {% if p.status == 'available' %}bg-success{% elif p.status == 'occupied' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ p.status|capitalize }}</span>
            <div class="btn-group">
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('employee.apartments_list', building_id=p.id) }}" title="{{ _('Manage Apartments') }}"><i class="bi bi-house-door"></i></a>
              <a class="btn btn-sm btn-secondary" href="{{ url_for('employee.properties_edit', prop_id=p.id) }}" title="{{ _('Edit') }}"><i class="bi bi-pencil-square"></i></a>
            </div>
          </div>
        </div>
        <div class="card-footer p-2 d-flex gap-1">
          <a class="btn btn-sm btn-outline-primary flex-grow-1" href="{{ url_for('employee.properties_share', prop_id=p.id) }}"><i class="bi bi-share"></i></a>
          <button type="button" class="btn btn-sm btn-outline-secondary btn-copy" 
                  onclick="navigator.clipboard.writeText('{{ url_for('public_property_view', token=share_tokens[p.id], _external=True) }}'); this.innerText='{{ _('Copied') }}'; setTimeout(()=>this.innerText='{{ _('Copy') }}',1500);">
            <i class="bi bi-clipboard"></i>
          </button>
          <form method="post" action="{{ url_for('employee.properties_delete', prop_id=p.id) }}" onsubmit="return confirm('{{ _('Are you sure?') }}');">
            <button class="btn btn-sm btn-outline-danger" type="submit"><i class="bi bi-trash"></i></button>
          </form>
        </div>
      </div>
    </div>
    {% else %}
      <div class="text-muted">{{ _('No data') }}</div>
    {% endfor %}
  </div>
</div>

<div class="card-section">
  <h5 class="mb-3"><i class="bi bi-house-door me-1"></i>{{ _('Standalone Apartments') }}</h5>
  <div class="row g-3">
    {% for p in standalone_apartments %}
    <div class="col-6 col-md-4 col-lg-3">
      <div class="card h-100">
        {% set img = (p.images.split(',')[0] if p.images else None) %}
        {% if img %}
          <img class="square-thumb" src="{{ url_for('uploaded_file', filename=img) }}" alt="{{ p.title }}" />
        {% else %}
          <div class="square-thumb d-flex align-items-center justify-content-center text-muted">{{ _('No image') }}</div>
        {% endif %}
        <div class="card-body p-2">
          <div class="fw-semibold text-truncate" title="{{ p.title }}">{{ p.title }}</div>
          <div class="small text-muted">{{ p.bedrooms or '-' }} {{ _('bd') }} Â· {{ p.bathrooms or '-' }} {{ _('ba') }}</div>
          <div class="d-flex align-items-center justify-content-between mt-1">
            <span class="badge badge-status {% if p.status == 'available' %}bg-success{% elif p.status == 'occupied' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ p.status|capitalize }}</span>
            <a class="btn btn-sm btn-secondary" href="{{ url_for('employee.properties_edit', prop_id=p.id) }}" title="{{ _('Edit') }}"><i class="bi bi-pencil-square"></i></a>
          </div>
        </div>
        <div class="card-footer p-2 d-flex gap-1">
          <a class="btn btn-sm btn-outline-primary flex-grow-1" href="{{ url_for('employee.properties_share', prop_id=p.id) }}"><i class="bi bi-share"></i></a>
          <button type="button" class="btn btn-sm btn-outline-secondary btn-copy" 
                  onclick="navigator.clipboard.writeText('{{ url_for('public_property_view', token=share_tokens[p.id], _external=True) }}'); this.innerText='{{ _('Copied') }}'; setTimeout(()=>this.innerText='{{ _('Copy') }}',1500);">
            <i class="bi bi-clipboard"></i>
          </button>
          <form method="post" action="{{ url_for('employee.properties_delete', prop_id=p.id) }}" onsubmit="return confirm('{{ _('Are you sure?') }}');">
            <button class="btn btn-sm btn-outline-danger" type="submit"><i class="bi bi-trash"></i></button>
          </form>
        </div>
      </div>
    </div>
    {% else %}
      <div class="text-muted">{{ _('No data') }}</div>
    {% endfor %}
  </div>
</div>

<!-- Add Building Modal -->
<div class="modal fade" id="addBuildingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('employee.properties_create') }}" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-square me-1"></i>{{ _('Add Building') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="property_type" value="building" />
          <div class="mb-3">
            <label class="form-label">{{ _('Title') }}</label>
            <input class="form-control" name="title" required />
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">{{ _('Number of apartments') }}</label>
                <input class="form-control" name="num_apartments" type="number" min="0" step="1" />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">{{ _('Number of floors') }}</label>
                <input class="form-control" name="num_floors" type="number" min="0" step="1" />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i>{{ _('Create Property') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
